<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>QChat</title>

	<style>
:root {
	--u: 1.8vw;
	--c: #30f;
	--c2: #90f;
	--action: #205;
	--action2: #2a006c;
	--action3: #30a;
	--grey: #555;
	--grey-s: #5557;
	--fg: #141415;
	--fg2: #1f1f20;
	--fg3: #252526;
	--border: #333;
	--border2: #555;
	--border-width: calc(.12 * var(--u));
	--br: calc(1 * var(--u));
	--chat-margin: calc(1 * var(--u));
}
body {
	margin: 0;
	background: #000;
	overflow: hidden;
}
.btn {
	--btn-h: var(--h);
	--btn-s: var(--s);
	--btn-l: var(--l);
	--border: calc(.15 * var(--u));

	box-sizing: border-box;
	font-family: monospace;
	font-size: calc(2 * var(--u));
	color: #fff;

	background: hsl(var(--btn-h), calc(83% * var(--btn-s)), calc(57% * var(--btn-l)));
	border: var(--border) solid hsl(var(--btn-h), calc(70% * var(--btn-s)), calc(48% * var(--btn-l)));
	border-radius: var(--br);
	box-shadow:
		0 calc(var(--border)/2) calc(var(--border)/2) var(--border) hsla(var(--btn-h), calc(72% * var(--btn-s)), calc(30% * var(--btn-l)), 0.2),
		inset 0 calc(-1 * var(--border)) var(--border) 0 hsl(var(--btn-h), calc(70% * var(--btn-s)), calc(48% * var(--btn-l))),
		inset 0 0 0 var(--border) hsl(var(--btn-h), calc(92% * var(--btn-s)), calc(62% * var(--btn-l)));

	transition: .2s;
}
.btn:hover {
	--btn-l: calc(var(--l) * 1.05);
}
.btn:focus {
	outline: none;
}
.btn::selection {
	background: var(--c);
}
#top {
	position: absolute;
	top: 0;
	left: 0;
	height: calc(5 * var(--u));
	display: flex;
	align-items: center;
	width: calc(100vw - var(--chat-margin) - calc(2 * var(--u)));
	margin: 0 calc(2 * var(--u)) 0 var(--chat-margin);
	gap: var(--chat-margin);
}
#top button {
	position: relative;
	background: transparent;
	border: none;
	width: calc(2.5 * var(--u));
	height: calc(2.5 * var(--u));
}
#top button:focus {
	outline: none;
}
#top button svg {
	position: absolute;
	top: 0;
	left: 0;
	width: calc(2.5 * var(--u));
	height: calc(2.5 * var(--u));
	stroke: #fff;
}
#top .right {
	margin-left: auto;
	display: flex;
	align-items: center;
	gap: calc(1.2 * var(--chat-margin));
}
#top #channel {
	user-select: none;
	margin: 0;
	font-family: monospace;
	font-size: calc(2.5 * var(--u));
	color: var(--grey);
}
#top p.mod {
	user-select: none;
	margin: 0;
	font-family: monospace;
	color: #fff;
	font-size: calc(2.5 * var(--u));
	font-weight: 700;
}
.logo {
	user-select: none;
	margin: 0;
	font-family: monospace;
	color: #fff;
	font-size: calc(2.5 * var(--u));
}
.logo b {
	font-weight: 700;
}
.logo .version {
	color: var(--grey);
	font-size: calc(2 * var(--u));
}
#info {
	position: absolute;
	bottom: calc(1 * var(--u));
	width: calc(100vw - (1.2 * var(--u)) * 2);
	margin: 0 calc(1.2 * var(--u));
	display: flex;
	justify-content: space-between;
	align-items: center;
}
#info p {
	margin: 0;
	height: calc(2 * var(--u));
	font-family: monospace;
	font-size: calc(1.5 * var(--u));
	color: var(--grey);
}
#info p::selection {
	background: var(--grey-s);
}
#menu-wrapper {
	pointer-events: none;
	position: absolute;
	top: 0;
	left: -100vw;
	width: 100vw;
	height: 100vh;
	z-index: 50;
	display: grid;
	grid-template-columns: auto calc(5 * var(--u));
	transition: .5s;
}
#menu-wrapper #menu {
	width: 100%;
	height: 100%;
	background: #000;
	box-shadow: 0 0 calc(5 * var(--u)) 0 #000;
	display: flex;
	flex-direction: column;
	align-items: center;
}
#menu-wrapper #menu .logo {
	font-size: calc(3 * var(--u));
	margin: calc(5 * var(--u)) 0;
	text-align: center;
}
#menu-wrapper #menu div {
	width: 100%;
	height: max-content;
	display: flex;
	flex-direction: column;
	align-items: center;
	gap: calc(1 * var(--u));
}
#menu-wrapper #menu div[hidden] {
	display: none;
}
#menu-wrapper #menu input[type="text"], #menu-wrapper #menu input[type="password"], #menu-wrapper #menu button {
	width: 50%;
	height: calc(5 * var(--u));
	box-sizing: border-box;
	font-family: monospace;
	font-size: calc(2 * var(--u));
}
#menu-wrapper #menu input[type="text"]:focus, #menu-wrapper #menu input[type="password"]:focus, #menu-wrapper #menu button:focus {
	outline: none;
	border-color: var(--c);
}
#menu-wrapper #menu input[type="text"]::selection, #menu-wrapper #menu input[type="password"]::selection, #menu-wrapper #menu button::selection {
	background: var(--c);
}
#menu-wrapper #menu input[type="text"], #menu-wrapper #menu input[type="password"] {
	background: var(--fg);
	border: var(--border-width) solid var(--border);
	border-radius: var(--br);
	font-family: monospace;
	font-size: calc(2 * var(--u));
	padding-left: calc(1.25 * var(--u));
	color: #fff;
}
#menu-wrapper #menu button {
	background: var(--fg2);
	border: var(--border-width) solid var(--border2);
	border-radius: var(--br);
	color: #fff;
}
#menu-wrapper #menu button:hover {
	background: var(--fg3);
}
#menu-wrapper #menu h1, #menu-wrapper #menu h2, #menu-wrapper #menu p:not(.logo) {
	width: 50%;
	box-sizing: border-box;
	font-family: monospace;
	font-size: calc(2 * var(--u));
	margin: 0;
	text-align: center;
	color: #fff;
}
#menu-wrapper #menu h1::selection, #menu-wrapper #menu h2::selection, #menu-wrapper #menu p:not(.logo)::selection {
	background: #fff5;
}
#menu-wrapper #menu p:not(.logo) {
	font-size: calc(1.5 * var(--u));
}
#menu-wrapper #menu #logout-section h2 {
	margin: calc(1 * var(--u)) 0 calc(1.25 * var(--u)) 0;
}
#menu-wrapper #close-menu {
	position: relative;
	width: calc(5 * var(--u));
	height: calc(5 * var(--u));
	background: #000;
	border: none;
}
#menu-wrapper #close-menu:focus {
	outline: none;
}
#menu-wrapper #close-menu svg {
	position: absolute;
	top: 50%;
	left: 50%;
	transform: translate(-50%, -50%);
	width: calc(2.5 * var(--u));
	height: calc(2.5 * var(--u));
	stroke: #fff;
}
#menu-wrapper[data-active="1"] {
	left: 0;
	pointer-events: auto;
}
.lvl4 {
	background: linear-gradient(to bottom, var(--c) 20%, var(--c2));
	background-clip: text;
	-webkit-background-clip: text;
	color: transparent !important;
	-webkit-text-fill-color: transparent !important;
}
.lvl3 {
	background: linear-gradient(to bottom, #02d 20%, #0cf);
	background-clip: text;
	-webkit-background-clip: text;
	color: transparent !important;
	-webkit-text-fill-color: transparent !important;
}
.lvl2 {
	background: linear-gradient(to bottom, #f80 20%, #ff0);
	background-clip: text;
	-webkit-background-clip: text;
	color: transparent !important;
	-webkit-text-fill-color: transparent !important;
}
#chats {
	position: absolute;
	top: calc(5.5 * var(--u));
	left: 50%;
	transform: translateX(-50%);
	width: calc(100vw - var(--chat-margin) * 2);
	height: calc(100vh - (16.5 * var(--u)));
	height: calc(100dvh - (16.5 * var(--u)));
	padding-bottom: calc(1.25 * var(--u));
	box-sizing: border-box;
	overflow-x: hidden;
	overflow-y: scroll;
	display: flex;
	flex-direction: column;
	gap: calc(1.25 * var(--u));
	scrollbar-width: none;
}
#chats::-webkit-scrollbar {
	display: none;
}
#chats:focus {
	outline: var(--border-width) solid var(--c);
}
.chat {
	width: 100%;
	height: min-content;
	box-sizing: border-box;
	background: var(--fg);
	border: var(--border-width) solid var(--border);
	border-radius: var(--br);
	padding: 0 calc(.7 * var(--u)) calc(.5 * var(--u)) calc(.7 * var(--u));
}
.chat div {
	display: flex;
	align-items: center;
	margin: 0;
	margin-top: calc(.7 * var(--u));
	gap: calc(.7 * var(--u));
}
.chat h1 {
	font-family: monospace;
	margin: 0;
	font-size: calc(1.8 * var(--u));
	font-weight: 700;
}
.chat h2 {
	font-family: monospace;
	margin: 0;
	color: var(--grey);
	font-size: calc(1.2 * var(--u));
	font-weight: 700;
}
.chat h2::selection {
	background: var(--grey-s);
}
.chat p {
	margin: 0;
	margin-top: calc(.7 * var(--u));
	font-family: Arial;
	font-size: calc(1.5 * var(--u));
	font-weight: 500;
	line-height: calc(2 * var(--u));
}
.chat h1, .chat p, .chat span {
	color: #fff;
}
.chat h1::selection, .chat p::selection, .chat span::selection {
	background: #fff5;
}
.chat .mention {
	padding: var(--border-width);
	border: var(--border-width) solid var(--border);
	border-radius: calc(var(--br) / 2);
}
.chat .mod {
	margin: 0;
	margin-left: auto;
}
.chat .mod button {
	position: relative;
	background: transparent;
	border: none;
	width: calc(1.5 * var(--u));
	height: calc(1.5 * var(--u));
	padding: 0;
}
.chat .mod button:focus {
	outline: none;
}
.chat .mod button svg {
	position: absolute;
	top: 0;
	left: 0;
	width: calc(1.5 * var(--u));
	height: calc(1.5 * var(--u));
	stroke: #fff;
	stroke-width: 2px;
}
.pending {
	border-color: var(--border2);
}
#new {
	display: flex;
	align-items: center;
	gap: calc(.4 * var(--u));
	padding-left: calc(.7 * var(--u));
	box-sizing: border-box;
	background: var(--fg);
	border: var(--border-width) solid var(--border);
	border-radius: var(--br);
	position: absolute;
	bottom: calc(12.25 * var(--u));
	right: calc(1 * var(--u));
	box-shadow: 0 0 calc(1 * var(--u)) calc(-.5 * var(--u)) #000;
	transition: .2s;
	z-index: 10;
}
#new p {
	color: #fff;
	font-family: Arial;
	margin: calc(.5 * var(--u)) 0;
	font-size: calc(2 * var(--u));
}
#new svg {
	width: calc(2 * var(--u));
	height: calc(2 * var(--u));
}
#new svg path {
	stroke: #fff;
}
#new:hover {
	background: var(--fg2);
	border: var(--border-width) solid var(--border2);
	transform: scale(1.03);
}
#new[hidden] {
	display: none;
}

#error {
	position: absolute;
	top: calc(5 * var(--u));
	left: 50%;
	transform: translateX(-50%);
	width: calc(100% - var(--chat-margin) * 2);
	height: calc(100% - (16 * var(--u)));
	box-sizing: border-box;
	background: var(--fg);
	border: var(--border-width) solid var(--border);
	border-radius: var(--br);
	z-index: 20;
}
#error p {
	position: absolute;
	top: 50%;
	left: 50%;
	transform: translate(-50%, -50%);
	width: 80%;
	text-align: center;
	margin: 0;
	font-size: calc(4 * var(--u));
	color: #fff;
	font-family: monospace;
}
#chat-wrapper:has(#error:not([hidden]))::before, #chat-wrapper:has(#error:not([hidden]))::after {
	height: calc(2 * var(--u));
	background: #000;
}
#bottom {
	position: absolute;
	bottom: 0;
	left: 0;
	width: 100vw;
	height: calc(11 * var(--u));
	background: #000;
}
#top, #bottom {
	z-index: 10;
	box-shadow: 0 0 calc(1 * var(--u)) calc(.5 * var(--u)) #000;
}
#msg-input {
	position: absolute;
	bottom: calc(4 * var(--u));
	left: 50%;
	transform: translateX(-50%);
	width: calc(100vw - var(--chat-margin) * 2);
	height: calc(7 * var(--u));
	resize: none;
	border-radius: calc(var(--br) * 2);
	font-size: calc(2 * var(--u));
	padding: calc(2.2 * var(--u)) calc(2 * var(--u));
	box-sizing: border-box;
	color: #ccc;
	background: var(--fg);
	border: var(--border-width) solid var(--border);
	transition: .4s;
}
#msg-input:focus {
	outline: none;
	border-color: var(--c);
}
#msg-input::selection {
	background: var(--c);
	color: #fff;
}
.underlined {
	color: var(--grey);
	font-family: monospace;
	font-weight: 500;
	position: relative;
	transition: .2s;
	z-index: 2;
	text-decoration: none;
}
.underline {
	--widen: 0%;
	--fix: 0%;
	width: calc(100% + var(--widen));
	transform: translateX(calc(-100% + var(--fix)));
	height: 1px;
	background: var(--grey);
	position: absolute;
	bottom: 0;
	transition: .2s;
	z-index: -1;
}
.underlined:hover {
	color: #000;
}
.underlined:hover .underline {
	height: 100%;
}
.underlined::selection {
	background: #fff5;
}
.template {
	display: none;
}
#alert {
	width: 100vw;
	height: 100vh;
	height: 100dvh;
	position: absolute;
	top: 0;
	left: 0;
	z-index: 100;
	background: #0007;
}
#alert #alert-box {
	max-width: 80vw;
	width: calc(50 * var(--u));
	box-sizing: border-box;
	padding: calc(2 * var(--u));
	position: absolute;
	top: 50%;
	left: 50%;
	transform: translate(-50%, -50%);
	background: var(--fg);
	border: var(--border-width) solid var(--border);
	border-radius: calc(var(--br) * 2);
}
#alert #alert-box #alert-text {
	margin: 0;
	text-align: center;
	font-size: calc(3 * var(--u));
	font-weight: 500;
	font-family: Arial;
	color: #fff;
}
#alert #alert-box #alert-options {
	display: flex;
	width: 100%;
	margin-top: calc(2 * var(--u));
	gap: calc(.5 * var(--u));

	align-items: center;
	justify-content: center;
}
#alert #alert-box #alert-options button {
	width: 100%;
	height: calc(4 * var(--u));

	--h: 0;
	--s: 0;
	--l: .4;
}
#alert #alert-box #alert-options button.action {
	--h: 250;
	--s: 1;
	--l: 1;
}
.mod[hidden] {
	display: none !important;
}
@media only screen and (min-aspect-ratio: 3/4) {
	:root {
		--u: 1.2vh;
	}
}
@media only screen and (min-aspect-ratio: 1/1) {
	#menu-wrapper {
		left: -80vh;
		grid-template-columns: calc(80vh - (5 * var(--u))) calc(5 * var(--u));
	}
}
@media only screen and (min-width: 100vh) {
	#search {
		width: 80vw;
	}
	#results {
		width: calc(80vw - (3.5 * var(--u)));
	}
}
	</style>
</head>
<body>
	<div id="top">
		<button onclick="burger(1)">
			<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g><path d="M4 6H20M4 12H20M4 18H20" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg>
		</button>
		<p class="logo"><b class="lvl4">Q</b>Chat <span class="version">v1.3.2</span></p>
		<div class="right">
			<p class="mod lvl3" hidden>MOD</p>
			<p id="channel"></p>
		</div>
	</div>
	<div id="menu-wrapper" data-active="0">
		<div id="menu">
			<p class="logo"><b class="lvl4">Q</b>Chat</p>

			<div id="login-section">
				<p>Enter display name:</p>
				<input type="text" placeholder="Name" id="login-display" oninput="format(this)">
				
				<p>OR</p>

				<input type="text" placeholder="Username" id="login-user" oninput="format(this)">
				<input type="password" placeholder="Password" id="login-password">
				<button onclick="login()">Login</button>
			</div>
			<div id="logout-section" hidden>
				<p>Signed in as:</p>
				<h2 id="logged-in"></h2>
				<button onclick="logout()">Logout</button>
			</div>
		</div>
		<button id="close-menu" onclick="burger(0)">
			<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g><path d="M15 6L9 12L15 18" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg>
		</button>
	</div>
	
	<div id="chats">
		<div class="chat template">
			<div>
				<h1></h1>
				<h2></h2>
				<div class="mod" hidden>
					<button class="mod-delete" onclick="modDelete(this)">
						<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g><path d="M6 6L18 18M18 6L6 18" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg>
					</button>
				</div>
			</div>
			<p></p>
		</div>
	</div>

	<button id="new" onclick="scrollBottom()" hidden>
		<p>New</p>
		<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g><path d="M12 6V18M12 18L7 13M12 18L17 13" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg>
	</button>

	<div id="error" hidden>
		<p></p>
	</div>

	<dialog id="alert">
		<div id="alert-box">
			<p id="alert-text">Example</p>
			<div id="alert-options">
				<button class="btn" id="alert-cancel">CANCEL</button>
				<button class="btn action" id="alert-ok">OK</button>
			</div>
		</div>
	</dialog>

	<div id="bottom">
		<textarea id="msg-input" placeholder="Loading..."></textarea>

		<div id="info">
			<p>chat.qwk.zone</p>
			<p>Made by <span><a class="underlined" href="https://qwkdev.github.io/" target="_blank" aria-label="label">qwk<span class="underline" style="--widen: 5%; --fix: 1%;"></span></a></span></p>
		</div>
	</div>

	<script>
		const MAX_NAME_LENGTH = 16;
		function safeText(text) {
			return text.replace(/[^a-zA-Z0-9_-]/g, '').slice(0, MAX_NAME_LENGTH);
		}

		const CHANNEL = safeText(window.location.pathname.slice(1)) || 'main';
		const SERVER = 'https://qchat.pythonanywhere.com';

		let session = {
			user: null,
			level: 0
		}

		const loginSection = document.getElementById('login-section');
		const menuEle = {
			display: document.getElementById('login-display'),
			user: document.getElementById('login-user'),
			password: document.getElementById('login-password'),
			loggedin: document.getElementById('logged-in')
		}
		const logoutSection = document.getElementById('logout-section');

		function format(e) {
			e.value = safeText(e.value);
		}

		function fixMenuSections() {
			if (!session.user) {
				loginSection.hidden = false;
				logoutSection.hidden = true;

				menuEle.user.value = '';
				menuEle.password.value = '';
			} else {
				loginSection.hidden = true;
				logoutSection.hidden = false;

				menuEle.loggedin.innerText = parseUser(session.user, session.level);
				menuEle.loggedin.className = `lvl${Number(session.level) || 0}`;
			}

			const modHidden = !session.user || session.level < 3;
			document.querySelectorAll('.mod').forEach(e => e.hidden = modHidden);
		}
		async function login() {
			if (!menuEle.user.value || !menuEle.password.value) return;

			format(menuEle.user);

			await fetch(`${SERVER}/login`, {
				method: 'POST',
				credentials: 'include',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					user: menuEle.user.value.startsWith('@') ? menuEle.user.value : '@' + menuEle.user.value,
					password: menuEle.password.value
				})
			})
				.then(resp => resp.json())
				.then(data => {
					if (data.success === true) {
						session.user = data.user || null;
						session.level = data.level || 0;
						
						menuEle.password.value = '';
						fixMenuSections();
					} else showError('Client Error:', data.error);
				})
				.catch(e => showError('Network Error:', e));
		}
		async function logout() {
			await fetch(`${SERVER}/logout`, {
				method: 'POST',
				credentials: 'include',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					user: getUser()
				})
			})
				.then(resp => resp.json())
				.then(data => {
					if (data.success === true) {
						session.user = null;
						session.level = 0;

						fixMenuSections();
					} else showError('Client Error:', data.error);
				})
				.catch(e => showError('Network Error:', e));
		}

		function parseChannel(channel) {
			if (
				!channel.startsWith('~') &&
				!channel.startsWith('^')
			) {
				return `#${channel}`;
			} else return channel;
		}

		const channelName = parseChannel(CHANNEL);
		document.getElementById('channel').innerText = channelName;

		const msgInput = document.getElementById('msg-input');
		msgInput.placeholder = `Message ${channelName}`;

		const errorWall = document.getElementById('error');

		const chat = document.getElementById('chats');
		const chatTemplate = document.querySelector('.chat.template');

		function scrollBottom(smooth=true) {
			chat.scrollTo({ top: chat.scrollHeight, behavior: smooth ? 'smooth' : 'instant' });
		}

		function parseEpoch(epoch) {
			if (epoch === 0) return '';

			const date = new Date( epoch*1000 );
			const now = new Date();
			const isToday =
				date.getDate() === now.getDate() &&
				date.getMonth() === now.getMonth() &&
				date.getFullYear() === now.getFullYear();

			const hours = String(date.getHours()).padStart(2, '0');
			const minutes = String(date.getMinutes()).padStart(2, '0');

			if (isToday) {
				return `${hours}:${minutes}`;
			} else {
				const day = String(date.getDate()).padStart(2, '0');
				const month = String(date.getMonth() + 1).padStart(2, '0');
				return `${hours}:${minutes} ${day}/${month}`;
			}
		}

		function parseUser(user, level) {
			if (level === 0) return user;
			// else if (level === 4) return `[${user}]`;
			else return `@${user}`;

			// switch (level) {
			// 	case 0: return user;
			// 	case 1: return `@${user}`;
			// 	case 2: return `;${user}`;
			// 	case 3: return `^${user}`;
			// 	case 4: return `[${user}]`;
			// 	default: return user;
			// }
		}
		function getUser(force=false) {
			const resp = session.user ? parseUser(session.user, session.level) : (menuEle.display.value || '')

			if (force && !resp) {
				burger(1);
				menuEle.display.focus();
				showAlert('Please enter a display name to chat');
			} else return resp;
		}

		function checkExists(msgId) {
			for (const e of chat.querySelectorAll('.chat:not(.template)')) {
				if (msgId === parseInt(e.dataset.id)) return true;
			}
			return false;
		}
		function getLatest() {
			return Array.from(chat.querySelectorAll('.chat:not(.template)'))
				.map(e => parseInt(e.dataset.id)).at(-1) || -1;
		}

		/////

		function modDelete(btn) {
			const msg = parseInt(btn.parentElement.parentElement.parentElement.dataset.id);
			if (Number.isNaN(msg)) return;

			showAlert('Confirm deletion', () => modSendDelete(msg), true);
		}
		async function modSendDelete(msg) {
			const user = getUser(true);
			await fetch(`${SERVER}/mod/delete/${CHANNEL}`, {
				method: 'POST',
				credentials: 'include',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({ msg, user })
			})
				.then(resp => resp.json())
				.then(data => {
					if (data.success !== true) {
						showError('Client Error:', data.error);
					} else {
						chat.querySelectorAll('.chat:not(.template)').forEach(e => e.remove());
						sync();
					}
				})
				.catch(e => showError('Network Error:', e));
		}

		/////

		const newChatsBtn = document.getElementById('new');
		const newChatsText = newChatsBtn.querySelector('p');
		let newChats = 0;
		const observer = new IntersectionObserver(t => {
			t.forEach(e => {
				if (e.isIntersecting) {
					newChats--;
					if (newChats < 0) newChats = 0;
					newChatsBtn.hidden = newChats == 0;
					observer.unobserve(e.target);
				}
			});
		}, {
			root: null,
			threshold: 0.5
		});

		const bottomError = 10; // px
		function addChat(atBottom, msgId, epoch, level, user, parts, init=false, pending=false) {
			if (!pending && checkExists(msgId)) return;

			const newChat = chatTemplate.cloneNode(true);
			newChat.classList.remove('template');

			const newUsername = newChat.querySelector('h1');
			const newDate = newChat.querySelector('h2');
			if (!user) {
				if (epoch === 0) newChat.querySelector('div').remove();
				else {
					newUsername.remove();
					newDate.innerText = parseEpoch(epoch);
				}
			} else {
				newUsername.innerText = parseUser(user, level);
				newUsername.classList = `lvl${level}`;
				newDate.innerText = parseEpoch(epoch);
			}

			const text = newChat.querySelector('p');
			parts.forEach(part => {
				if (typeof part === 'string') {
					text.append(document.createTextNode(part));
				} else {
					if (part.type === 'newline') {
						text.append(document.createElement('br'));
					} else if (part.type === 'mention') {
						const newMention = document.createElement('span');
						newMention.classList = `mention lvl${part.level}`;
						newMention.innerText = part.value;
						text.append(newMention);
					}
				}
			});

			newChat.dataset.id = msgId;

			if (pending) {
				newChat.classList.add('pending');
			}
			if (init) {
				chat.appendChild(newChat);
			} else {
				for (const e of Array.from(chat.querySelectorAll('.chat')).reverse()) {
					const eId = parseInt(e.dataset.id);
					if (!eId || msgId > eId) {
						chat.insertBefore(newChat, e.nextSibling);
						if (scrollPrompt && !atBottom) {
							newChats++;
							newChatsBtn.hidden = false;
							newChatsText.innerText = `${newChats} New`;
							observer.observe(newChat);
						}
						break;
					}
				}

				if (!scrollPrompt && atBottom) scrollBottom();
			}
		}

		function addPending(message, level, user) {
			const parts = message.split('\n').flatMap((e, i, a) => i < a.length - 1 ? [e, {'type': 'newline'}] : [e]);
			addChat(true, 0, new Date().getTime() / 1000, level, user.startsWith('@') ? user.slice(1) : user, parts, true, true);
			scrollBottom();
		}
		function removePending() {
			Array.from(chat.querySelectorAll('.chat.pending')).forEach(e => e.remove());
		}

		function showError(type=null, text=null) {
			if (text === null) {
				errorWall.hidden = true;
			} else {
				errorWall.querySelector('p').innerHTML = '';
				errorWall.querySelector('p').append(
					document.createTextNode(type),
					document.createElement('br'),
					document.createTextNode(text)
				);
				errorWall.hidden = false;
				burger(0);
			}
		}

		const alertModal = document.getElementById('alert');
		const alertEle = {
			text: document.getElementById('alert-text'),
			options: document.getElementById('alert-options'),
			cancel: document.getElementById('alert-cancel'),
			ok: document.getElementById('alert-ok')
		}
		alertModal.addEventListener('click', e => {
			if (e.target === alertModal) alertModal.close();
		});
		function showAlert(html='Alert', ok=true, cancel=false) {
			alertEle.text.innerHTML = html;
			if (typeof ok === 'function') {
				alertEle.ok.onclick = function() {
					alertModal.close();
					ok();
				}
			} else alertEle.ok.onclick = () => alertModal.close();
			if (typeof cancel === 'function') {
				alertEle.cancel.onclick = function() {
					alertModal.close();
					cancel();
				}
			} else alertEle.cancel.onclick = () => alertModal.close();

			alertEle.options.hidden = ok === false && cancel === false;
			alertEle.ok.hidden = ok === false;
			alertEle.cancel.hidden = cancel === false;
			alertModal.showModal();
		}

		const menuWrapper = document.getElementById('menu-wrapper');
		function burger(value) {
			menuWrapper.dataset.active = value;
			if (value == 1) menuWrapper.querySelector('button, input, textarea')?.focus();
		}
		menuWrapper.addEventListener('click', e => {
			if (e.target === menuWrapper) burger(0);
		})
		msgInput.addEventListener('keydown', e => {
			if (e.key === 'Enter') {
				if (e.shiftKey) return;
				else {
					e.preventDefault();
					addPending(msgInput.value, session.level, getUser(true));
					send(msgInput.value);
					msgInput.value = '';
				}
			}
		});
		msgInput.addEventListener('focus', e => {
			getUser(true);
		});
		document.addEventListener('keydown', e => {
			if (e.key === 'Escape') burger(menuWrapper.dataset.active == 0 ? 1 : 0)
			if (menuWrapper.dataset.active == 0) {
				if (
					e.key !== 'Tab' &&
					e.key !== 'Escape' &&
					e.target !== msgInput
				) {
					if (e.key === 'Enter' || e.key === 'Space') {
						e.preventDefault();	
					}
					msgInput.focus();
				}
			}
		});

		menuEle.user.addEventListener('keydown', e => {
			if (e.key === 'Enter') {
				if (e.shiftKey) return;
				else {
					e.preventDefault();
					menuEle.password.focus();
				}
			}
		});
		menuEle.password.addEventListener('keydown', e => {
			if (e.key === 'Enter') {
				if (e.shiftKey) return;
				else {
					e.preventDefault();
					login();
				}
			}
		});

		async function sync() {
			const user = getUser(false);
			const latest = getLatest();
			await fetch(`${SERVER}/get/${CHANNEL}?after=${latest}`, {
				method: 'POST',
				credentials: 'include',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({ user })
			})
				.then(resp => resp.json())
				.then(data => {
					if (data.success === true) {
						showError();
						const atBottom = chat.scrollHeight - chat.scrollTop - chat.clientHeight < bottomError;
						data.chat.forEach(c => addChat(
							atBottom,
							...c
						));
						removePending();
					} else showError('Client Error:', data.error);
				})
				.catch(e => showError('Network Error:', e));
		}

		async function send(msg) {
			const user = getUser(true);
			await fetch(`${SERVER}/msg/${CHANNEL}`, {
				method: 'POST',
				credentials: 'include',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({ msg, user })
			})
				.then(resp => resp.json())
				.then(data => {
					if (data.success !== true) {
						showError('Client Error:', data.error);
					}
				})
				.catch(e => showError('Network Error:', e));
		}

		let syncInterval;
		function startSync() {
			if (!syncInterval) {
				sync();
				syncInterval = setInterval(sync, 5000);
			}
		}
		function stopSync() {
			if (syncInterval) {
				clearInterval(syncInterval);
				syncInterval = null;
			}
		}
		
		window.addEventListener('message', e => {
			if (e.data && e.data.type === 'control-sync') {
				if (e.data.sync) startSync();
				else stopSync();
			}
		});

		let scrollPrompt = false;
		sync().then(() => { 
			scrollBottom(false);
			scrollPrompt = true;
		});
		startSync();
	</script>
</body>
</html>
